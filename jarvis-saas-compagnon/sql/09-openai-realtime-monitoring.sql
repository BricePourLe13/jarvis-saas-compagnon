-- üéØ MONITORING OPENAI REALTIME API - M√©triques techniques R√âELLES
-- Bas√© sur la documentation officielle OpenAI Realtime API

-- ====================================
-- ü§ñ TABLE: openai_realtime_sessions
-- ====================================

CREATE TABLE IF NOT EXISTS openai_realtime_sessions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id TEXT NOT NULL, -- OpenAI session ID
  gym_id UUID NOT NULL REFERENCES gyms(id) ON DELETE CASCADE,
  kiosk_slug TEXT NOT NULL,
  
  -- üìÖ Session Timeline
  session_started_at TIMESTAMPTZ NOT NULL,
  session_ended_at TIMESTAMPTZ,
  session_duration_seconds INTEGER, -- Dur√©e totale session
  
  -- üîå Connexion & Transport
  connection_type TEXT NOT NULL CHECK (connection_type IN ('websocket', 'webrtc')), 
  connection_established_at TIMESTAMPTZ,
  connection_closed_at TIMESTAMPTZ,
  disconnect_reason TEXT, -- 'user_ended', 'timeout', 'error', 'technical_failure'
  
  -- üéôÔ∏è Audio Configuration
  input_audio_format TEXT DEFAULT 'pcm16', -- Format audio input
  output_audio_format TEXT DEFAULT 'pcm16', -- Format audio output
  voice_model TEXT, -- 'alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'
  
  -- üîÑ Turn Detection Settings
  turn_detection_type TEXT DEFAULT 'server_vad', -- 'none', 'server_vad', 'semantic_vad'
  vad_threshold DECIMAL(3,2), -- Seuil d√©tection voix
  vad_prefix_padding_ms INTEGER, -- Padding avant d√©tection
  vad_silence_duration_ms INTEGER, -- Dur√©e silence pour fin de parole
  
  -- üìä Session Metrics
  total_audio_input_duration_ms INTEGER, -- Dur√©e totale audio utilisateur
  total_audio_output_duration_ms INTEGER, -- Dur√©e totale audio IA
  total_user_turns INTEGER DEFAULT 0, -- Nombre prises de parole utilisateur
  total_ai_turns INTEGER DEFAULT 0, -- Nombre r√©ponses IA
  total_interruptions INTEGER DEFAULT 0, -- Interruptions utilisateur
  
  -- üí∞ Co√ªts & Tokens
  total_input_tokens INTEGER DEFAULT 0,
  total_output_tokens INTEGER DEFAULT 0,
  total_input_audio_tokens INTEGER DEFAULT 0,
  total_output_audio_tokens INTEGER DEFAULT 0,
  total_cost_usd DECIMAL(10,6),
  
  -- üö® Erreurs Session
  had_errors BOOLEAN DEFAULT false,
  error_count INTEGER DEFAULT 0,
  critical_errors TEXT[], -- Array des erreurs critiques
  
  -- üìù M√©tadonn√©es
  session_instructions TEXT, -- Instructions syst√®me utilis√©es
  temperature DECIMAL(3,2), -- Temp√©rature mod√®le
  max_response_output_tokens TEXT, -- Limite tokens r√©ponse
  tools_used TEXT[], -- Fonctions appel√©es pendant session
  session_metadata JSONB DEFAULT '{}'::jsonb,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ====================================
-- üéôÔ∏è TABLE: openai_realtime_audio_events
-- ====================================

CREATE TABLE IF NOT EXISTS openai_realtime_audio_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES openai_realtime_sessions(id) ON DELETE CASCADE,
  gym_id UUID NOT NULL REFERENCES gyms(id) ON DELETE CASCADE,
  
  -- üìù Event Details
  event_type TEXT NOT NULL, -- Types d'√©v√©nements OpenAI
  event_id TEXT, -- ID √©v√©nement OpenAI (optionnel)
  event_timestamp TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- üé§ Audio Input Events
  -- 'input_audio_buffer.speech_started', 'input_audio_buffer.speech_stopped'
  -- 'input_audio_buffer.committed', 'conversation.item.input_audio_transcription.completed'
  speech_started_at TIMESTAMPTZ,
  speech_stopped_at TIMESTAMPTZ,
  speech_duration_ms INTEGER,
  user_transcript TEXT, -- Transcription Whisper
  
  -- üîä Audio Output Events  
  -- 'response.audio_transcript.delta', 'response.audio_transcript.done'
  -- 'response.audio.delta', 'response.audio.done'
  ai_transcript_partial TEXT, -- Transcript partiel IA
  ai_transcript_final TEXT, -- Transcript final IA
  audio_bytes_received INTEGER, -- Bytes audio re√ßus
  audio_generation_duration_ms INTEGER,
  
  -- ‚ö° Response Events
  -- 'response.created', 'response.done', 'response.cancelled'
  response_id TEXT, -- ID r√©ponse OpenAI
  response_status TEXT, -- 'in_progress', 'completed', 'cancelled', 'failed'
  response_latency_ms INTEGER, -- Temps entre requ√™te et d√©but r√©ponse
  
  -- üõ†Ô∏è Function Call Events
  -- 'response.function_call_arguments.done'
  function_name TEXT,
  function_arguments JSONB,
  function_call_id TEXT,
  
  -- üö® Error Events
  error_type TEXT, -- Type erreur OpenAI
  error_message TEXT,
  error_code TEXT,
  
  -- üìä Technical Metrics
  buffer_size_bytes INTEGER, -- Taille buffer audio
  processing_time_ms INTEGER, -- Temps traitement √©v√©nement
  
  -- üìù Raw Event Data
  raw_event_data JSONB, -- Donn√©es brutes √©v√©nement OpenAI
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ====================================
-- üåê TABLE: openai_realtime_webrtc_stats
-- ====================================

CREATE TABLE IF NOT EXISTS openai_realtime_webrtc_stats (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES openai_realtime_sessions(id) ON DELETE CASCADE,
  gym_id UUID NOT NULL REFERENCES gyms(id) ON DELETE CASCADE,
  
  -- ‚è∞ Timing
  measured_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  stats_interval_seconds INTEGER DEFAULT 5, -- Intervalle mesure
  
  -- üîå Connection Stats (RTCPeerConnection)
  connection_state TEXT, -- 'new', 'connecting', 'connected', 'disconnected', 'failed', 'closed'
  ice_connection_state TEXT, -- 'new', 'checking', 'connected', 'completed', 'failed', 'disconnected', 'closed'
  ice_gathering_state TEXT, -- 'new', 'gathering', 'complete'
  
  -- üì° Network Quality
  rtt_ms INTEGER, -- Round Trip Time
  packets_sent INTEGER, -- Paquets envoy√©s
  packets_received INTEGER, -- Paquets re√ßus
  packets_lost INTEGER, -- Paquets perdus
  packet_loss_rate DECIMAL(5,4), -- Taux perte paquets (0-1)
  
  -- üéµ Audio Quality (inbound/outbound streams)
  audio_level_input DECIMAL(5,2), -- Niveau audio entr√©e (0-1)
  audio_level_output DECIMAL(5,2), -- Niveau audio sortie (0-1)
  jitter_ms DECIMAL(8,2), -- Gigue r√©seau
  
  -- üìä Bandwidth
  bytes_sent INTEGER, -- Bytes envoy√©s
  bytes_received INTEGER, -- Bytes re√ßus
  bitrate_kbps INTEGER, -- D√©bit actuel
  
  -- üéß Audio Stream Stats
  audio_codec TEXT, -- Codec utilis√© (probablement Opus)
  sample_rate INTEGER, -- Taux √©chantillonnage
  channels INTEGER, -- Nombre canaux audio
  
  -- üîä Audio Processing
  echo_cancellation_enabled BOOLEAN, -- Annulation √©cho active
  noise_suppression_enabled BOOLEAN, -- Suppression bruit active
  auto_gain_control_enabled BOOLEAN, -- Contr√¥le gain automatique
  
  -- üìù Browser/Device Info
  user_agent TEXT, -- User agent navigateur
  browser_name TEXT, -- Nom navigateur
  device_type TEXT, -- 'desktop', 'mobile', 'tablet'
  os_name TEXT, -- Syst√®me exploitation
  
  -- üìä Raw WebRTC Stats
  raw_webrtc_stats JSONB, -- Stats WebRTC brutes compl√®tes
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ====================================
-- üí∞ TABLE: openai_realtime_cost_tracking
-- ====================================

CREATE TABLE IF NOT EXISTS openai_realtime_cost_tracking (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES openai_realtime_sessions(id) ON DELETE CASCADE,
  gym_id UUID NOT NULL REFERENCES gyms(id) ON DELETE CASCADE,
  
  -- üìÖ P√©riode
  hour_bucket TIMESTAMPTZ NOT NULL, -- Bucket horaire (d√©but heure)
  
  -- üìä Tokens & Usage
  total_sessions INTEGER DEFAULT 0,
  total_session_duration_seconds INTEGER DEFAULT 0,
  total_input_tokens INTEGER DEFAULT 0,
  total_output_tokens INTEGER DEFAULT 0,
  total_input_audio_tokens INTEGER DEFAULT 0,
  total_output_audio_tokens INTEGER DEFAULT 0,
  
  -- üí∞ Co√ªts D√©taill√©s (selon pricing OpenAI)
  input_text_tokens_cost_usd DECIMAL(10,6) DEFAULT 0,
  output_text_tokens_cost_usd DECIMAL(10,6) DEFAULT 0,
  input_audio_tokens_cost_usd DECIMAL(10,6) DEFAULT 0,
  output_audio_tokens_cost_usd DECIMAL(10,6) DEFAULT 0,
  total_cost_usd DECIMAL(10,6) DEFAULT 0,
  
  -- üìà Performance Metrics
  avg_session_duration_seconds INTEGER,
  avg_response_latency_ms INTEGER,
  avg_turn_count DECIMAL(5,2),
  successful_sessions INTEGER DEFAULT 0,
  failed_sessions INTEGER DEFAULT 0,
  success_rate DECIMAL(5,4), -- Taux succ√®s (0-1)
  
  -- üåê Connection Stats
  webrtc_sessions INTEGER DEFAULT 0,
  websocket_sessions INTEGER DEFAULT 0,
  total_connection_failures INTEGER DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- Index unique par gym/heure
  UNIQUE(gym_id, hour_bucket)
);

-- ====================================
-- üìä INDEXES POUR PERFORMANCE
-- ====================================

-- Sessions indexes
CREATE INDEX IF NOT EXISTS idx_openai_realtime_sessions_gym_id ON openai_realtime_sessions(gym_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_sessions_started_at ON openai_realtime_sessions(session_started_at);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_sessions_kiosk_slug ON openai_realtime_sessions(kiosk_slug);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_sessions_session_id ON openai_realtime_sessions(session_id);

-- Audio events indexes  
CREATE INDEX IF NOT EXISTS idx_openai_realtime_audio_events_session_id ON openai_realtime_audio_events(session_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_audio_events_gym_id ON openai_realtime_audio_events(gym_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_audio_events_event_type ON openai_realtime_audio_events(event_type);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_audio_events_timestamp ON openai_realtime_audio_events(event_timestamp);

-- WebRTC stats indexes
CREATE INDEX IF NOT EXISTS idx_openai_realtime_webrtc_stats_session_id ON openai_realtime_webrtc_stats(session_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_webrtc_stats_gym_id ON openai_realtime_webrtc_stats(gym_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_webrtc_stats_measured_at ON openai_realtime_webrtc_stats(measured_at);

-- Cost tracking indexes
CREATE INDEX IF NOT EXISTS idx_openai_realtime_cost_tracking_gym_id ON openai_realtime_cost_tracking(gym_id);
CREATE INDEX IF NOT EXISTS idx_openai_realtime_cost_tracking_hour_bucket ON openai_realtime_cost_tracking(hour_bucket);

-- ====================================
-- üîí ROW LEVEL SECURITY
-- ====================================

-- Activer RLS
ALTER TABLE openai_realtime_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE openai_realtime_audio_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE openai_realtime_webrtc_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE openai_realtime_cost_tracking ENABLE ROW LEVEL SECURITY;

-- Politiques d'acc√®s (pour dev/admin complet)
CREATE POLICY "Allow all operations on openai_realtime_sessions" ON openai_realtime_sessions FOR ALL USING (true);
CREATE POLICY "Allow all operations on openai_realtime_audio_events" ON openai_realtime_audio_events FOR ALL USING (true);
CREATE POLICY "Allow all operations on openai_realtime_webrtc_stats" ON openai_realtime_webrtc_stats FOR ALL USING (true);
CREATE POLICY "Allow all operations on openai_realtime_cost_tracking" ON openai_realtime_cost_tracking FOR ALL USING (true);

-- ====================================
-- ü§ñ TRIGGERS
-- ====================================

-- Trigger pour updated_at
CREATE TRIGGER update_openai_realtime_sessions_updated_at
  BEFORE UPDATE ON openai_realtime_sessions
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_openai_realtime_cost_tracking_updated_at
  BEFORE UPDATE ON openai_realtime_cost_tracking
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ====================================
-- üëÅÔ∏è VUES DASHBOARD TEMPS R√âEL
-- ====================================

-- Vue status sessions en cours
CREATE OR REPLACE VIEW v_openai_realtime_active_sessions AS
SELECT 
  s.id,
  s.session_id,
  s.gym_id,
  g.name as gym_name,
  s.kiosk_slug,
  s.session_started_at,
  s.connection_type,
  s.voice_model,
  s.turn_detection_type,
  s.total_user_turns,
  s.total_ai_turns,
  s.total_interruptions,
  s.total_cost_usd,
  
  -- Dur√©e session actuelle
  EXTRACT(EPOCH FROM (now() - s.session_started_at))::integer as current_duration_seconds,
  
  -- Derni√®re activit√© audio
  (SELECT MAX(ae.event_timestamp) 
   FROM openai_realtime_audio_events ae 
   WHERE ae.session_id = s.id) as last_audio_activity,
   
  -- Qualit√© connexion WebRTC r√©cente
  (SELECT ws.connection_state 
   FROM openai_realtime_webrtc_stats ws 
   WHERE ws.session_id = s.id 
   ORDER BY ws.measured_at DESC 
   LIMIT 1) as current_connection_state

FROM openai_realtime_sessions s
LEFT JOIN gyms g ON s.gym_id = g.id
WHERE s.session_ended_at IS NULL -- Sessions actives uniquement
ORDER BY s.session_started_at DESC;

-- Vue m√©triques par kiosk (24h)
CREATE OR REPLACE VIEW v_openai_realtime_kiosk_stats_24h AS
SELECT 
  g.id as gym_id,
  g.name as gym_name,
  g.kiosk_config->>'kiosk_url_slug' as kiosk_slug,
  
  -- Sessions derni√®res 24h
  COUNT(s.id) as sessions_24h,
  COUNT(CASE WHEN s.session_ended_at IS NOT NULL THEN 1 END) as completed_sessions,
  COUNT(CASE WHEN s.session_ended_at IS NULL THEN 1 END) as active_sessions,
  
  -- Dur√©e moyenne
  AVG(s.session_duration_seconds)::integer as avg_session_duration_seconds,
  SUM(s.session_duration_seconds)::integer as total_session_duration_seconds,
  
  -- Performance audio
  AVG(s.total_user_turns)::decimal(5,2) as avg_user_turns,
  AVG(s.total_ai_turns)::decimal(5,2) as avg_ai_turns,
  AVG(s.total_interruptions)::decimal(5,2) as avg_interruptions,
  
  -- Co√ªts
  SUM(s.total_cost_usd)::decimal(8,4) as total_cost_24h_usd,
  AVG(s.total_cost_usd)::decimal(6,4) as avg_cost_per_session_usd,
  
  -- Tokens
  SUM(s.total_input_tokens) as total_input_tokens,
  SUM(s.total_output_tokens) as total_output_tokens,
  SUM(s.total_input_audio_tokens) as total_input_audio_tokens,
  SUM(s.total_output_audio_tokens) as total_output_audio_tokens,
  
  -- Erreurs
  COUNT(CASE WHEN s.had_errors THEN 1 END) as sessions_with_errors,
  (COUNT(CASE WHEN s.had_errors THEN 1 END) * 100.0 / NULLIF(COUNT(s.id), 0))::decimal(5,2) as error_rate_percent,
  
  -- Connexions
  COUNT(CASE WHEN s.connection_type = 'webrtc' THEN 1 END) as webrtc_sessions,
  COUNT(CASE WHEN s.connection_type = 'websocket' THEN 1 END) as websocket_sessions,
  
  -- Mod√®les voix populaires
  string_agg(DISTINCT s.voice_model, ', ') as voice_models_used,
  
  -- Derni√®re activit√©
  MAX(s.session_started_at) as last_session_at

FROM gyms g
LEFT JOIN openai_realtime_sessions s ON g.id = s.gym_id 
  AND s.session_started_at > now() - INTERVAL '24 hours'
WHERE g.kiosk_config->>'kiosk_url_slug' IS NOT NULL
GROUP BY g.id, g.name, g.kiosk_config->>'kiosk_url_slug'
ORDER BY sessions_24h DESC;

-- ====================================
-- ‚úÖ VALIDATION
-- ====================================

SELECT 
  'üéØ MONITORING OPENAI REALTIME API CR√â√â!' as result,
  'Tables: sessions, audio_events, webrtc_stats, cost_tracking' as tables_created,
  'Vues: v_openai_realtime_active_sessions, v_openai_realtime_kiosk_stats_24h' as views_created,
  'M√©triques: WebRTC, Audio Events, Co√ªts OpenAI, Performance' as metrics_available,
  now() as created_at;